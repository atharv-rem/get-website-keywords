import ollama 
import json
import openpyxl
from openpyxl import load_workbook

print("Starting the keyword extraction process...")

#load the meta description data and running ollama to get keywords
with open('scraper/scraper/meta_desc.json', 'r') as file:
    data = json.load(file)
    results = []
    tool_number = 1
    for item in data:
        print(f"Processing tool {tool_number}")
        tool_number += 1
        meta_desc = item.get('meta_description')
        if not meta_desc:
            results.append({
            "title":item.get('title'),
            "seo_keywords": "No meta description found"
            })
            continue

        try:
            response = ollama.chat(
                model='mistral',
                messages=[
                    {
                        "role": "user",
                        "content": f"Extract 5â€“10 relevant SEO keywords from the following {meta_desc}. Only return the keywords, comma-separated, and don't include extra text. If no keywords can be found, return 'null'."
                    }
                ]
            )

            keywords = response['message']['content']
            keywords = keywords.strip().split(',')
            keywords = [keyword.strip() for keyword in keywords if keyword.strip()]
            keywords = [k for k in keywords if len(k) <= 20]
                    
            results.append({
                "title":item.get('title'),
                    "seo_keywords": keywords
            })
        except Exception as e:
            print(f"Error processing tool {tool_number}: {e}")
            results.append({
                "title": item.get('title'),
                "seo_keywords": "null"
            })

#loading the result into a json file named seo_keywords.json        
with open('seo_keywords.json', 'w') as f:
    json.dump(results, f, indent=4)
print("Keyword extraction completed and saved to seo_keywords.json")


# Load the existing excel file and add the keywords
file_path = r"C:\Users\athar\Downloads\color database.xlsx"
workbook = load_workbook(file_path)
sheet = workbook.active

# Add "SEO Keywords" header in the next empty column
header_row = next(sheet.iter_rows(min_row=1, max_row=1))
next_col = len(header_row) + 1  # one after last column
sheet.cell(row=1, column=next_col, value="SEO Keywords")

# Write keywords row by row (starting from second row)
for row_num, item in enumerate(results, start=2):
    keywords = item['seo_keywords']
    if isinstance(keywords, list):
        keywords = ', '.join(keywords)
    sheet.cell(row=row_num, column=next_col, value=keywords)

# Save workbook
workbook.save(file_path)
print("Keywords added to Excel file successfully.")